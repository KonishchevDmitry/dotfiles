#!/bin/bash
#
# Updates all Vim plugins to the latest version
#

set -eu

show_help() {
    cat <<EOF
usage: $1 [-h] [-f]

Update all Vim plugins

optional arguments:
  -h, --help    show this help message and exit
  -f, --force   force reinstall from scratch
EOF
}

parse_args() {
    eval set -- "$@"

    while [ $# -gt 0 ]; do
        case "$1" in
            -h) show_help "$0"; exit 0;;
            -f|--force) force_reinstall=1;;
            --) shift; break;;
            (-*) die "Unrecognized option: $1.";;
            (*) break;;
        esac
        shift
    done

    [ $# -eq 0 ] || die "Invalid parameter: $1."
}

die() {
    echo "Error:" "$@" >&2
    exit 1
}

update_plugin() {
    local full_name="$1"
    local name="${full_name##*/}"
    local path="${2:-$plugin_dir/$name}"

    echo

    if [ -e "$path" ]; then
        echo "Updating $name..."
        (cd "$path" && git pull)
    else
        echo "Installing $name..."
        git clone "https://github.com/$full_name.git" "$path"
        (cd "$path" && git gc --aggressive)
    fi

    if [ -e "$path/.gitmodules" ]; then
        (cd "$path" && git submodule update --init)
    fi
}

sync_plugins() {
    local plugins="$1"

    local plugin
    local plugin_names
    local installed_plugins

    local deleted_plugins deleted_plugin

    plugin_names="$(sed 's#^.*/##' <<< "$plugins")"
    installed_plugins="$(cd "$plugin_dir" && ls -1)"
    deleted_plugins="$(comm -23 <(sort <<< "$installed_plugins") <(sort <<< "$plugin_names"))"

    for deleted_plugin in $deleted_plugins; do
        echo "Removing $deleted_plugin..."
        rm -rf "$plugin_dir/$deleted_plugin"
    done

    for plugin in $plugins; do
        update_plugin "$plugin"
    done
}

configure_rust_plugins() {
    echo "Configure Rust plugins..."

    local racer_path="$plugin_dir/racer"
    (cd "$racer_path" && cargo build --release)

    local rust_version
    rust_version="$(rustc --version)"
    rust_version="${rust_version#rustc }"

    local package_name="rustc-$rust_version"
    local src_path="$racer_path/$package_name"
    local src_archive_path="$src_path-src.tar.gz"

    if [ ! -e "$src_path" ]; then
        curl "http://static.rust-lang.org/dist/rustc-$rust_version-src.tar.gz" -o "$src_archive_path"
        tar -xf "$src_archive_path" -C "$racer_path"
    fi

    rm -f "$src_archive_path"

    local src_link_path="$racer_path/rust-src"
    [ ! -e "$src_link_path" ] || unlink "$src_link_path"
    ln -s "$package_name/src" "$src_link_path"
}

main() {
    local with_rust=1

    echo "Syncing Vim plugins..."

    if ! which -s rustc || ! which -s cargo; then
        echo "Skipping Rust plugins installation: rustc/cargo is not installed."
        with_rust=0
    fi

    [ "$force_reinstall" -eq 0 ] || rm -rf ~/.vim/pathogen "$plugin_dir"
    [ -d "$plugin_dir" ] || mkdir "$plugin_dir"

    local plugins='
        scrooloose/syntastic
        vim-scripts/OmniCppComplete
        davidhalter/jedi-vim
        scrooloose/nerdtree
        jistr/vim-nerdtree-tabs
        kien/ctrlp.vim
        junegunn/vim-easy-align
        szw/vim-ctrlspace
        Glench/Vim-Jinja2-Syntax
        groenewege/vim-less
    '

    if [ "$(uname)" = Darwin ]; then
        plugins+='
            cypok/KeyboardLayoutSwitcher
        '
    fi

    if [ "$(uname)" = Linux -a -n "${DISPLAY:-}" ]; then
        plugins+='
            lyokha/vim-xkbswitch
            ierton/xkb-switch
        '
    fi

    if [ "$with_rust" -eq 1 ]; then
        plugins+='
            rust-lang/rust.vim
            phildawes/racer
            racer-rust/vim-racer
        '
    fi

    sync_plugins "$plugins"
    update_plugin tpope/vim-pathogen ~/.vim/pathogen

    if [ "$with_rust" -eq 1 ]; then
        configure_rust_plugins
    fi

    if [ "$(uname)" = Linux -a -n "${DISPLAY:-}" ]; then
        echo;echo "Compile xkb-switch..."
        (cd "$plugin_dir/xkb-switch" && cmake . && make && mv libxkbswitch.so ~/.vim && git clean -df)
    fi
}

force_reinstall=0
plugin_dir=~/.vim/bundle

if [ "$(uname)" = Darwin -a "$(which getopt)" = /usr/bin/getopt ]; then
    options="$(getopt hf "$@")"
else
    options="$(getopt -n "$0" -o hf -l help,force -- "$@")"
fi

parse_args "$options"
main
