#!/bin/bash -e
#
# Since OS X doesn't have a decent packaging system with a lot of packages,
# many of them are installed using Mac Ports, pip and npm. In this case it's
# much easier to handle all of this mess by script like this which allows to
# clear all accumulated garbage and reinstall all required foreign packages.
#


git_package() {
    echo -n "git+ssh://git@konishchev.ru/~git/$1.git"
}

github_package() {
    echo -n "https://github.com/KonishchevDmitry/$1/archive/master.zip"
}

check_system_directory() {
    local system_dir="$1"
    local white_list="$2"

    [ -d "$system_dir" ] || return 0

    local contents="$(ls -1 "$system_dir")"
    [ -z "$white_list" ] || contents="$(echo "$contents" | egrep -v "$white_list")" ||:

    if [ -n "$contents" ]; then
        echo "Warning: System directory $system_dir contains the following files:" >&2
        echo "$contents" >&2
    fi
}

uninstall_packages() {
    echo "Stopping the services..."

    [ ! -f /Library/LaunchAgents/org.freedesktop.dbus-session.plist ] || \
        launchctl unload /Library/LaunchAgents/org.freedesktop.dbus-session.plist

    echo "Dropping selected alternatives..."

    if [ -n "$port_pyver" ] && port select --show pyflakes > /dev/null 2>&1; then
        sudo port select --set pyflakes none ||:
    fi

    echo "Uninstalling all pip packages..."

    if which pip$pyver > /dev/null; then
        pip$pyver list | cut -f 1 -d ' ' | xargs sudo pip$pyver uninstall -y
    fi

    echo "Uninstalling all npm packages..."

    if which npm > /dev/null; then
        npm ls -gp | awk -F/ '/node_modules/ && !/node_modules.*node_modules/ {print $NF}' | egrep -v '^npm$' | sudo xargs npm -g rm
    fi

    echo "Uninstalling all MacPorts packages..."

    if [ -n "$(port list installed)" ]; then
        sudo port uninstall installed
    fi

    check_system_directory /opt/local/Library/Frameworks/Python.framework
    check_system_directory /opt/local/bin '^(daemondo|port|portf|portindex|portmirror)$'

    echo "Uninstallation finished successfully."
}

install_packages() {
    echo "Installing all required packages..."; set -x

    sudo port selfupdate

    # Mac Port's bash in contrast to system's bash supports completion
    #
    # Don't forget to set '/opt/local/bin/bash -l' as a shell in the terminal
    # emulator
    sudo port install bash bash-completion

    sudo port install htop pstree tree watch

    # We already have git in the system, but this package brings to us git
    # completion and gitk tool
    sudo port install git-core

    # Meld requires a LOT of packages including GTK and DBus
    #
    # Alternative to meld: opendiff (command line tool which runs XCode's
    # FileMerge)
    if [ "$install_meld" -eq 1 ]; then
        sudo port install rarian # Missing requirement for meld
        sudo port install meld
        launchctl load -w /Library/LaunchAgents/org.freedesktop.dbus-session.plist
        sudo port install gnome-themes-standard
        echo 'include "/opt/local/share/themes/Adwaita/gtk-2.0/gtkrc"' > ~/.gtkrc-2.0
    fi

    sudo port install python$port_pyver
    sudo port install py$port_pyver-pip
    sudo port install py$port_pyver-virtualenvwrapper

    sudo port install py$port_pyver-pyflakes
    [ -z "$port_pyver" ] || sudo port select --set pyflakes py$port_pyver-pyflakes

    sudo pip$pyver install pyvsb
    sudo pip$pyver install $(github_package pydeposits)
    sudo pip$pyver install $(git_package credit-calculator)

    sudo port install npm
    sudo npm install --global less

    set +x; echo "Installation finished successfully."
}

question_user() {
    local answer
    echo -n "Are you sure want to $1? (y/n) "
    read answer
    [ "$answer" = "y" ]
}

die() {
    echo "$@" >&2
    exit 1
}

show_usage() {
    die "Usage: $0 {install|uninstall}"
}


if [ $# -ne 1 ]; then
    show_usage
fi

if [ "$(whoami)" = root ]; then
    die "The script must be run from user."
fi

# Python version which is used to install all packages
pyver=3.3
port_pyver=33

install_meld=1

case $1 in
    "install") question_user "install all required packages" && install_packages ;;
    "uninstall") question_user "uninstall all required packages" && uninstall_packages ;;
    *) show_usage ;;
esac
